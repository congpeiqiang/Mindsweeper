# ğŸ¯ Mindsweeper æ•°æ®åº“å’ŒAPIå®ä½“å®ç°æ€»ç»“

## ğŸ“‹ å®ç°æ¦‚è¿°

æœ¬æ¬¡å®ç°å®Œæˆäº† **PostgreSQLæ•°æ®åº“æ“ä½œå®ä½“** å’Œ **APIè¯·æ±‚/å“åº”å®ä½“** çš„åˆ†ç¦»è®¾è®¡ï¼Œéµå¾ªæœ€ä½³å®è·µçš„æ¶æ„æ¨¡å¼ã€‚

### å®ç°åŸåˆ™
- âœ… **å…³æ³¨ç‚¹åˆ†ç¦»**: æ•°æ®åº“æ“ä½œå®ä½“ä¸APIå®ä½“å®Œå…¨åˆ†ç¦»
- âœ… **å•ä¸€èŒè´£**: æ¯ä¸ªæ¨¡å—åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½
- âœ… **æ˜“äºç»´æŠ¤**: æ¸…æ™°çš„ç›®å½•ç»“æ„å’Œå‘½åè§„èŒƒ
- âœ… **ç±»å‹å®‰å…¨**: ä½¿ç”¨Pydanticè¿›è¡Œæ•°æ®éªŒè¯
- âœ… **æ–‡æ¡£å®Œæ•´**: æ¯ä¸ªæ¨¡å‹éƒ½æœ‰è¯¦ç»†çš„æ³¨é‡Šå’Œç¤ºä¾‹

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
Mindsweeper/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ schema/                    # æ•°æ®åº“æ“ä½œå®ä½“ (SQLAlchemy ORM)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ base.py               # åŸºç¡€é…ç½®
â”‚   â”‚   â”œâ”€â”€ user.py               # ç”¨æˆ·è¡¨
â”‚   â”‚   â”œâ”€â”€ knowledge_base.py      # çŸ¥è¯†åº“è¡¨
â”‚   â”‚   â”œâ”€â”€ file.py               # æ–‡ä»¶è¡¨
â”‚   â”‚   â”œâ”€â”€ document.py           # æ–‡æ¡£è¡¨
â”‚   â”‚   â”œâ”€â”€ search_history.py      # æœç´¢å†å²è¡¨
â”‚   â”‚   â””â”€â”€ operation_log.py       # æ“ä½œæ—¥å¿—è¡¨
â”‚   â”‚
â”‚   â””â”€â”€ models/                    # APIè¯·æ±‚/å“åº”å®ä½“ (Pydantic)
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ enums.py              # æšä¸¾ç±»å‹
â”‚       â””â”€â”€ schemas.py            # Pydanticæ¨¡å‹
â”‚
â””â”€â”€ config/
    â””â”€â”€ settings.py               # åº”ç”¨é…ç½®
```

---

## ğŸ—„ï¸ æ•°æ®åº“æ“ä½œå®ä½“ (app/schema/)

### 1. åŸºç¡€é…ç½® (base.py)
```python
Base = declarative_base()  # SQLAlchemyåŸºç¡€ç±»
```

### 2. ç”¨æˆ·è¡¨ (user.py)
- **è¡¨å**: `users`
- **å­—æ®µ**: id, username, email, password_hash, full_name, avatar_url, is_active, created_at, updated_at, deleted_at
- **ç´¢å¼•**: username, email, created_at

### 3. çŸ¥è¯†åº“è¡¨ (knowledge_base.py)
- **è¡¨å**: `knowledge_bases`
- **å­—æ®µ**: id, user_id, name, description, embedding_model, status, files_count, documents_count, total_size, created_at, updated_at, deleted_at
- **ç´¢å¼•**: user_id, status, created_at
- **å…³ç³»**: ä¸€ä¸ªç”¨æˆ·æ‹¥æœ‰å¤šä¸ªçŸ¥è¯†åº“

### 4. æ–‡ä»¶è¡¨ (file.py)
- **è¡¨å**: `files`
- **å­—æ®µ**: id, kb_id, filename, file_type, file_size, file_path, status, error_message, chunks_count, created_at, updated_at, deleted_at
- **ç´¢å¼•**: kb_id, status, created_at
- **å…³ç³»**: ä¸€ä¸ªçŸ¥è¯†åº“åŒ…å«å¤šä¸ªæ–‡ä»¶

### 5. æ–‡æ¡£è¡¨ (document.py)
- **è¡¨å**: `documents`
- **å­—æ®µ**: id, file_id, kb_id, content, chunk_index, metadata, milvus_id, created_at, updated_at
- **ç´¢å¼•**: file_id, kb_id, milvus_id, (kb_id, file_id)
- **å…³ç³»**: ä¸€ä¸ªæ–‡ä»¶åŒ…å«å¤šä¸ªæ–‡æ¡£åˆ†å—

### 6. æœç´¢å†å²è¡¨ (search_history.py)
- **è¡¨å**: `search_history`
- **å­—æ®µ**: id, user_id, kb_id, query, results_count, execution_time, created_at
- **ç´¢å¼•**: user_id, kb_id, created_at

### 7. æ“ä½œæ—¥å¿—è¡¨ (operation_log.py)
- **è¡¨å**: `operation_logs`
- **å­—æ®µ**: id, user_id, operation_type, resource_type, resource_id, status, error_message, ip_address, user_agent, created_at
- **ç´¢å¼•**: user_id, created_at, operation_type

---

## ğŸ”Œ APIè¯·æ±‚/å“åº”å®ä½“ (app/models/)

### 1. æšä¸¾ç±»å‹ (enums.py)

#### FileStatus
- `PROCESSING` - å¤„ç†ä¸­
- `COMPLETED` - å·²å®Œæˆ
- `FAILED` - å¤±è´¥

#### KBStatus
- `ACTIVE` - æ´»è·ƒ
- `ARCHIVED` - å·²å½’æ¡£
- `DELETED` - å·²åˆ é™¤

#### OperationType
- `UPLOAD` - ä¸Šä¼ 
- `DELETE` - åˆ é™¤
- `SEARCH` - æœç´¢
- `UPDATE` - æ›´æ–°
- `CREATE` - åˆ›å»º
- `DOWNLOAD` - ä¸‹è½½

#### ResourceType
- `FILE` - æ–‡ä»¶
- `DOCUMENT` - æ–‡æ¡£
- `KNOWLEDGE_BASE` - çŸ¥è¯†åº“
- `USER` - ç”¨æˆ·

#### OperationStatus
- `SUCCESS` - æˆåŠŸ
- `FAILED` - å¤±è´¥

#### SortOrder
- `ASC` - å‡åº
- `DESC` - é™åº

### 2. Pydanticæ¨¡å‹ (schemas.py)

#### é€šç”¨å“åº”
- `ApiResponse` - é€šç”¨APIå“åº”
- `PaginatedResponse` - åˆ†é¡µå“åº”

#### ç”¨æˆ·ç›¸å…³
- `UserCreate` - åˆ›å»ºç”¨æˆ·è¯·æ±‚
- `UserUpdate` - æ›´æ–°ç”¨æˆ·è¯·æ±‚
- `UserResponse` - ç”¨æˆ·å“åº”

#### çŸ¥è¯†åº“ç›¸å…³
- `KnowledgeBaseCreate` - åˆ›å»ºçŸ¥è¯†åº“è¯·æ±‚
- `KnowledgeBaseUpdate` - æ›´æ–°çŸ¥è¯†åº“è¯·æ±‚
- `KnowledgeBaseResponse` - çŸ¥è¯†åº“å“åº”
- `KnowledgeBaseStats` - çŸ¥è¯†åº“ç»Ÿè®¡

#### æ–‡ä»¶ç›¸å…³
- `FileResponse` - æ–‡ä»¶å“åº”
- `FileListResponse` - æ–‡ä»¶åˆ—è¡¨å“åº”

#### æ–‡æ¡£ç›¸å…³
- `DocumentResponse` - æ–‡æ¡£å“åº”
- `DocumentListResponse` - æ–‡æ¡£åˆ—è¡¨å“åº”

#### æœç´¢ç›¸å…³
- `SearchRequest` - æœç´¢è¯·æ±‚
- `HybridSearchRequest` - æ··åˆæœç´¢è¯·æ±‚
- `SearchResult` - æœç´¢ç»“æœé¡¹
- `SearchResponse` - æœç´¢å“åº”

---

## âš™ï¸ åº”ç”¨é…ç½® (config/settings.py)

### é…ç½®åˆ†ç±»

#### åº”ç”¨é…ç½®
- `APP_NAME` - åº”ç”¨åç§°
- `APP_VERSION` - åº”ç”¨ç‰ˆæœ¬
- `DEBUG` - è°ƒè¯•æ¨¡å¼
- `ENVIRONMENT` - ç¯å¢ƒ

#### æœåŠ¡å™¨é…ç½®
- `HOST` - ä¸»æœºåœ°å€
- `PORT` - ç«¯å£å·
- `RELOAD` - è‡ªåŠ¨é‡è½½

#### æ•°æ®åº“é…ç½®
- `DATABASE_URL` - PostgreSQLè¿æ¥å­—ç¬¦ä¸²
- `DATABASE_ECHO` - SQLæ—¥å¿—è¾“å‡º
- `DATABASE_POOL_SIZE` - è¿æ¥æ± å¤§å°
- `DATABASE_MAX_OVERFLOW` - æœ€å¤§æº¢å‡ºè¿æ¥æ•°

#### Milvusé…ç½®
- `MILVUS_HOST` - Milvusä¸»æœº
- `MILVUS_PORT` - Milvusç«¯å£
- `MILVUS_COLLECTION_NAME` - é›†åˆåç§°
- `MILVUS_EMBEDDING_DIM` - åµŒå…¥ç»´åº¦
- `MILVUS_INDEX_TYPE` - ç´¢å¼•ç±»å‹
- `MILVUS_METRIC_TYPE` - è·ç¦»åº¦é‡

#### Redisé…ç½®
- `REDIS_URL` - Redisè¿æ¥å­—ç¬¦ä¸²
- `REDIS_CACHE_TTL` - ç¼“å­˜è¿‡æœŸæ—¶é—´

#### å‘é‡åŒ–é…ç½®
- `EMBEDDING_MODEL` - åµŒå…¥æ¨¡å‹
- `EMBEDDING_BATCH_SIZE` - æ‰¹å¤„ç†å¤§å°

#### æ–‡ä»¶å¤„ç†é…ç½®
- `MAX_FILE_SIZE` - æœ€å¤§æ–‡ä»¶å¤§å°
- `ALLOWED_FILE_TYPES` - å…è®¸çš„æ–‡ä»¶ç±»å‹
- `UPLOAD_DIR` - ä¸Šä¼ ç›®å½•
- `TEMP_DIR` - ä¸´æ—¶ç›®å½•
- `PROCESSED_DIR` - å¤„ç†åç›®å½•

#### åˆ†å—é…ç½®
- `CHUNK_SIZE` - åˆ†å—å¤§å°
- `CHUNK_OVERLAP` - åˆ†å—é‡å 

#### æœç´¢é…ç½®
- `SEARCH_TOP_K` - è¿”å›ç»“æœæ•°
- `SEARCH_THRESHOLD` - ç›¸ä¼¼åº¦é˜ˆå€¼

#### è®¤è¯é…ç½®
- `SECRET_KEY` - å¯†é’¥
- `ALGORITHM` - ç®—æ³•
- `ACCESS_TOKEN_EXPIRE_MINUTES` - Tokenè¿‡æœŸæ—¶é—´

#### Celeryé…ç½®
- `CELERY_BROKER_URL` - Broker URL
- `CELERY_RESULT_BACKEND` - ç»“æœåç«¯

#### æ—¥å¿—é…ç½®
- `LOG_LEVEL` - æ—¥å¿—çº§åˆ«
- `LOG_FILE` - æ—¥å¿—æ–‡ä»¶

#### CORSé…ç½®
- `CORS_ORIGINS` - å…è®¸çš„æº
- `CORS_ALLOW_CREDENTIALS` - å…è®¸å‡­è¯
- `CORS_ALLOW_METHODS` - å…è®¸çš„æ–¹æ³•
- `CORS_ALLOW_HEADERS` - å…è®¸çš„å¤´

---

## ğŸ”§ æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ (scripts/init_db.py)

### åŠŸèƒ½
1. æµ‹è¯•æ•°æ®åº“è¿æ¥
2. åˆ›å»ºæ‰€æœ‰è¡¨
3. åˆ›å»ºç´¢å¼•
4. è¾“å‡ºåˆå§‹åŒ–ç»“æœ

### ä½¿ç”¨æ–¹æ³•
```bash
python scripts/init_db.py
```

### è¾“å‡ºç¤ºä¾‹
```
==================================================
å¼€å§‹åˆå§‹åŒ–æ•°æ®åº“...
==================================================
âœ“ æ•°æ®åº“è¿æ¥æˆåŠŸ

åˆ›å»ºæ•°æ®åº“è¡¨...
âœ“ æ•°æ®åº“è¡¨åˆ›å»ºæˆåŠŸ

åˆ›å»ºæ•°æ®åº“ç´¢å¼•...
âœ“ æ•°æ®åº“ç´¢å¼•åˆ›å»ºæˆåŠŸ

==================================================
âœ“ æ•°æ®åº“åˆå§‹åŒ–å®Œæˆï¼
==================================================
```

---

## ğŸ“Š æ•°æ®å…³ç³»å›¾

```
users (1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (N) knowledge_bases
                            â”‚
                            â”œâ”€â”€â”€ (N) files
                            â”‚         â”‚
                            â”‚         â””â”€â”€â”€ (N) documents â”€â”€â”€â”€ Milvus
                            â”‚
                            â””â”€â”€â”€ (N) search_history

operation_logs â”€â”€â”€â”€ users
```

---

## ğŸ”„ æ•°æ®æµå‘

### æ–‡ä»¶ä¸Šä¼ æµç¨‹
```
1. ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶
   â†“
2. åˆ›å»ºFileè®°å½• (status=processing)
   â†“
3. å¤„ç†æ–‡ä»¶ï¼Œç”Ÿæˆchunks
   â†“
4. åˆ›å»ºDocumentè®°å½•
   â†“
5. å‘é‡åŒ–ï¼Œæ’å…¥Milvus
   â†“
6. æ›´æ–°Fileè®°å½• (status=completed)
   â†“
7. æ›´æ–°KnowledgeBaseç»Ÿè®¡ä¿¡æ¯
   â†“
8. è®°å½•OperationLog
```

### æœç´¢æµç¨‹
```
1. ç”¨æˆ·è¾“å…¥æŸ¥è¯¢
   â†“
2. è®°å½•SearchHistory
   â†“
3. æŸ¥è¯¢å‘é‡åŒ–
   â†“
4. Milvuså‘é‡æœç´¢
   â†“
5. è·å–Documentè¯¦æƒ…
   â†“
6. è¿”å›SearchResponse
```

---

## âœ¨ ç‰¹è‰²åŠŸèƒ½

### 1. å®Œæ•´çš„æ•°æ®éªŒè¯
- Pydanticæ¨¡å‹è‡ªåŠ¨éªŒè¯è¾“å…¥æ•°æ®
- ç±»å‹æ£€æŸ¥å’ŒèŒƒå›´éªŒè¯
- è‡ªå®šä¹‰éªŒè¯å™¨

### 2. è¯¦ç»†çš„æ–‡æ¡£
- æ¯ä¸ªå­—æ®µéƒ½æœ‰ä¸­æ–‡æè¿°
- åŒ…å«JSONç¤ºä¾‹
- æ”¯æŒSwaggerè‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£

### 3. çµæ´»çš„é…ç½®
- æ”¯æŒç¯å¢ƒå˜é‡é…ç½®
- æ”¯æŒ.envæ–‡ä»¶
- é»˜è®¤å€¼è®¾ç½®

### 4. å®Œå–„çš„ç´¢å¼•
- å•å­—æ®µç´¢å¼•
- å¤åˆç´¢å¼•
- éƒ¨åˆ†ç´¢å¼•

### 5. è½¯åˆ é™¤æ”¯æŒ
- ä½¿ç”¨deleted_atå­—æ®µ
- ä¿ç•™æ•°æ®å†å²
- æ”¯æŒæ¢å¤

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. é…ç½®ç¯å¢ƒ
```bash
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œé…ç½®æ•°æ®åº“è¿æ¥ç­‰
```

### 2. å®‰è£…ä¾èµ–
```bash
pip install -r requirements.txt
```

### 3. åˆå§‹åŒ–æ•°æ®åº“
```bash
python scripts/init_db.py
```

### 4. å¯åŠ¨åº”ç”¨
```bash
uvicorn app.main:app --reload
```

### 5. è®¿é—®APIæ–‡æ¡£
```
http://localhost:8000/docs
```

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åˆ›å»ºçŸ¥è¯†åº“
```python
from app.models import KnowledgeBaseCreate
from app.schema import KnowledgeBase

kb_data = KnowledgeBaseCreate(
    name="æŠ€æœ¯æ–‡æ¡£åº“",
    description="å­˜å‚¨æŠ€æœ¯ç›¸å…³æ–‡æ¡£"
)

# åœ¨APIä¸­ä½¿ç”¨
kb = KnowledgeBase(
    user_id=1,
    name=kb_data.name,
    description=kb_data.description
)
```

### æœç´¢æ–‡æ¡£
```python
from app.models import SearchRequest

search_req = SearchRequest(
    query="Pythonæ•™ç¨‹",
    knowledge_base_id="550e8400-e29b-41d4-a716-446655440000",
    top_k=10,
    threshold=0.5
)
```

---

## âœ… å®Œæˆæ¸…å•

- âœ… åˆ›å»ºæ•°æ®åº“æ“ä½œå®ä½“ (6ä¸ªè¡¨)
- âœ… åˆ›å»ºAPIè¯·æ±‚/å“åº”å®ä½“ (20+ä¸ªæ¨¡å‹)
- âœ… åˆ›å»ºæšä¸¾ç±»å‹ (6ä¸ª)
- âœ… å®Œå–„åº”ç”¨é…ç½® (80+ä¸ªé…ç½®é¡¹)
- âœ… åˆ›å»ºæ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
- âœ… å®Œæ•´çš„ä¸­æ–‡æ–‡æ¡£å’Œç¤ºä¾‹

---

## ğŸ¯ åç»­æ­¥éª¤

1. **å®ç°APIå±‚** - åˆ›å»ºFastAPIè·¯ç”±
2. **å®ç°æœåŠ¡å±‚** - åˆ›å»ºä¸šåŠ¡é€»è¾‘
3. **å®ç°æ ¸å¿ƒå±‚** - åˆ›å»ºæ–‡ä»¶å¤„ç†ã€å‘é‡åŒ–ç­‰
4. **ç¼–å†™æµ‹è¯•** - å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
5. **éƒ¨ç½²åº”ç”¨** - Dockerå’ŒKuberneteséƒ¨ç½²

---

**é¡¹ç›®åç§°**: Mindsweeper  
**å®ç°æ—¥æœŸ**: 2024å¹´1æœˆ  
**ç‰ˆæœ¬**: 1.0.0  
**çŠ¶æ€**: âœ… æ•°æ®åº“å’ŒAPIå®ä½“å®ç°å®Œæˆ  

**ä¸‹ä¸€æ­¥**: å¼€å§‹å®ç°APIå±‚å’Œä¸šåŠ¡é€»è¾‘ï¼ğŸš€

