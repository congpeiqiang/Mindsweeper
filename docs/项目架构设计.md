# 知识库管理系统 - 项目架构设计

## 系统架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                     客户端 (Web/Mobile)                      │
└────────────────────────┬────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────┐
│                    FastAPI 应用层                            │
│  ┌──────────────┬──────────────┬──────────────┬────────────┐ │
│  │ Files API    │ Documents    │ Search API   │ Knowledge  │ │
│  │              │ API          │              │ Base API   │ │
│  └──────────────┴──────────────┴──────────────┴────────────┘ │
└────────────────────────┬────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────┐
│                    业务服务层                                │
│  ┌──────────────┬──────────────┬──────────────┬────────────┐ │
│  │ File Service │ Document     │ Knowledge    │ Search     │ │
│  │              │ Service      │ Base Service │ Service    │ │
│  └──────────────┴──────────────┴──────────────┴────────────┘ │
└────────────────────────┬────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────┐
│                    核心业务层                                │
│  ┌──────────────┬──────────────┬──────────────┬────────────┐ │
│  │ File         │ Vectorization│ Milvus       │ Search     │ │
│  │ Processor    │ Engine       │ Manager      │ Engine     │ │
│  └──────────────┴──────────────┴──────────────┴────────────┘ │
└────────────────────────┬────────────────────────────────────┘
                         │
        ┌────────────────┼────────────────┐
        │                │                │
┌───────▼──────┐  ┌──────▼──────┐  ┌─────▼──────┐
│  Milvus      │  │  PostgreSQL │  │  File      │
│  (向量库)    │  │  (元数据)   │  │  Storage   │
└──────────────┘  └─────────────┘  └────────────┘
```

## 核心模块详解

### 1. API层 (app/api/)

**职责**: 处理HTTP请求，参数验证，响应格式化

**主要接口**:
- `POST /api/v1/files/upload` - 上传文件
- `GET /api/v1/files/{file_id}` - 获取文件信息
- `DELETE /api/v1/files/{file_id}` - 删除文件
- `POST /api/v1/search` - 执行搜索
- `GET /api/v1/knowledge-bases` - 获取知识库列表

### 2. 服务层 (app/services/)

**职责**: 业务逻辑编排，事务管理，错误处理

**核心服务**:
- **FileService**: 文件上传、存储、删除
- **DocumentService**: 文档元数据管理
- **KnowledgeBaseService**: 知识库创建、管理
- **SearchService**: 搜索业务逻辑

### 3. 核心业务层 (app/core/)

#### 3.1 文件处理模块 (file_processor/)

**流程**:
```
上传文件 → 格式识别 → 内容提取 → 文本清洗 → 返回文本
```

**支持的格式**:
- **PDF**: 使用PyPDF2/pdfplumber提取文本
- **CSV**: 使用pandas读取数据
- **图片**: 使用OCR识别文本（Tesseract/PaddleOCR）
- **文本**: 直接处理

**接口设计**:
```python
class FileProcessor(ABC):
    @abstractmethod
    def process(self, file_path: str) -> str:
        """处理文件并返回文本内容"""
        pass
```

#### 3.2 向量化模块 (vectorization/)

**流程**:
```
原始文本 → 文本分块 → 嵌入模型 → 向量 → Milvus
```

**关键组件**:
- **Chunking**: 文本分块策略
  - 固定长度分块（512字符，256字符重叠）
  - 语义分块（基于句子边界）
  - 递归分块

- **Embeddings**: 嵌入模型
  - OpenAI Embeddings
  - Hugging Face模型
  - 本地模型（Sentence-Transformers）

#### 3.3 Milvus管理模块 (milvus_manager/)

**职责**: 向量数据库操作

**核心功能**:
- 连接管理和连接池
- 集合创建和维护
- 向量插入、更新、删除
- 向量搜索和过滤

**集合设计**:
```python
{
    "id": "primary_key",           # 主键
    "content": "text",             # 原始文本
    "embedding": "float_vector",   # 向量（1536维）
    "metadata": "json",            # 元数据
    "created_at": "timestamp"      # 创建时间
}
```

#### 3.4 搜索引擎模块 (search_engine/)

**流程**:
```
用户查询 → 查询向量化 → Milvus搜索 → 结果排序 → 返回结果
```

**功能**:
- 向量相似度搜索
- 混合搜索（向量+关键词）
- 结果重排和融合
- 查询优化

### 4. 数据模型层 (app/models/)

**Pydantic Schemas**: API请求/响应模型
**SQLAlchemy Models**: 关系数据库模型
**Enums**: 枚举类型定义

## 数据流

### 文件上传流程

```
1. 用户上传文件
   ↓
2. API验证文件格式和大小
   ↓
3. 保存文件到临时目录
   ↓
4. FileProcessor处理文件，提取文本
   ↓
5. 文本分块（Chunking）
   ↓
6. 调用嵌入模型生成向量
   ↓
7. 向量和元数据插入Milvus
   ↓
8. 文档元数据保存到PostgreSQL
   ↓
9. 返回上传成功响应
```

### 搜索流程

```
1. 用户输入查询
   ↓
2. 查询文本向量化
   ↓
3. Milvus向量搜索（Top-K）
   ↓
4. 结果重排和融合
   ↓
5. 返回搜索结果
```

## 技术栈

| 组件 | 技术 | 说明 |
|------|------|------|
| 后端框架 | FastAPI | 高性能异步框架 |
| 向量数据库 | Milvus | 开源向量数据库 |
| 关系数据库 | PostgreSQL | 元数据存储 |
| ORM | SQLAlchemy | 数据库ORM |
| 文件处理 | PyPDF2/pandas/Tesseract | 多格式支持 |
| 嵌入模型 | Sentence-Transformers | 文本向量化 |
| 异步任务 | Celery | 后台任务处理 |
| 缓存 | Redis | 缓存和队列 |
| 日志 | Python logging | 日志管理 |
| 测试 | pytest | 单元和集成测试 |

## 部署架构

```
┌─────────────────────────────────────────┐
│         Nginx (反向代理)                 │
└────────────────┬────────────────────────┘
                 │
    ┌────────────┼────────────┐
    │            │            │
┌───▼──┐    ┌───▼──┐    ┌───▼──┐
│ App  │    │ App  │    │ App  │
│ Pod1 │    │ Pod2 │    │ Pod3 │
└───┬──┘    └───┬──┘    └───┬──┘
    │           │           │
    └───────────┼───────────┘
                │
    ┌───────────┼───────────┐
    │           │           │
┌───▼──┐  ┌────▼────┐  ┌───▼──┐
│Milvus│  │PostgreSQL│  │Redis │
└──────┘  └──────────┘  └──────┘
```

## 扩展性考虑

1. **支持新的文件格式**: 继承FileProcessor基类
2. **支持新的嵌入模型**: 在embeddings.py中添加
3. **支持新的搜索策略**: 在search_engine中扩展
4. **支持多语言**: 在文本处理中添加语言检测
5. **支持实时更新**: 使用消息队列异步处理

## 性能优化

1. **向量搜索优化**: Milvus索引配置
2. **缓存策略**: Redis缓存热点数据
3. **异步处理**: 使用Celery处理长时间操作
4. **批量操作**: 批量插入向量
5. **连接池**: 复用数据库连接

