# 知识库管理系统 - 数据库设计

## 数据库架构

```
┌─────────────────────────────────────────┐
│         PostgreSQL (关系数据库)          │
│  - 元数据存储                            │
│  - 用户信息                              │
│  - 文件信息                              │
│  - 文档信息                              │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│         Milvus (向量数据库)              │
│  - 文档向量                              │
│  - 向量索引                              │
│  - 相似度搜索                            │
└─────────────────────────────────────────┘
```

## PostgreSQL表设计

### 1. 用户表 (users)

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(255) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    full_name VARCHAR(255),
    avatar_url VARCHAR(500),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP
);

CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
```

### 2. 知识库表 (knowledge_bases)

```sql
CREATE TABLE knowledge_bases (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id INTEGER NOT NULL REFERENCES users(id),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    embedding_model VARCHAR(255) DEFAULT 'sentence-transformers/all-MiniLM-L6-v2',
    status VARCHAR(50) DEFAULT 'active',  -- active, archived, deleted
    files_count INTEGER DEFAULT 0,
    documents_count INTEGER DEFAULT 0,
    total_size BIGINT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP
);

CREATE INDEX idx_kb_user_id ON knowledge_bases(user_id);
CREATE INDEX idx_kb_status ON knowledge_bases(status);
```

### 3. 文件表 (files)

```sql
CREATE TABLE files (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    kb_id UUID NOT NULL REFERENCES knowledge_bases(id),
    filename VARCHAR(255) NOT NULL,
    file_type VARCHAR(50),  -- pdf, csv, txt, jpg, png, etc.
    file_size BIGINT NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    status VARCHAR(50) DEFAULT 'processing',  -- processing, completed, failed
    error_message TEXT,
    chunks_count INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP
);

CREATE INDEX idx_files_kb_id ON files(kb_id);
CREATE INDEX idx_files_status ON files(status);
CREATE INDEX idx_files_created_at ON files(created_at);
```

### 4. 文档表 (documents)

```sql
CREATE TABLE documents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    file_id UUID NOT NULL REFERENCES files(id),
    kb_id UUID NOT NULL REFERENCES knowledge_bases(id),
    content TEXT NOT NULL,
    chunk_index INTEGER NOT NULL,
    metadata JSONB,  -- 存储额外元数据
    milvus_id BIGINT,  -- Milvus中的ID
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_documents_file_id ON documents(file_id);
CREATE INDEX idx_documents_kb_id ON documents(kb_id);
CREATE INDEX idx_documents_milvus_id ON documents(milvus_id);
```

### 5. 搜索历史表 (search_history)

```sql
CREATE TABLE search_history (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id),
    kb_id UUID NOT NULL REFERENCES knowledge_bases(id),
    query TEXT NOT NULL,
    results_count INTEGER,
    execution_time FLOAT,  -- 毫秒
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_search_history_user_id ON search_history(user_id);
CREATE INDEX idx_search_history_kb_id ON search_history(kb_id);
CREATE INDEX idx_search_history_created_at ON search_history(created_at);
```

### 6. 操作日志表 (operation_logs)

```sql
CREATE TABLE operation_logs (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    operation_type VARCHAR(50),  -- upload, delete, search, etc.
    resource_type VARCHAR(50),  -- file, document, knowledge_base
    resource_id UUID,
    status VARCHAR(50),  -- success, failed
    error_message TEXT,
    ip_address VARCHAR(45),
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_operation_logs_user_id ON operation_logs(user_id);
CREATE INDEX idx_operation_logs_created_at ON operation_logs(created_at);
```

## Milvus集合设计

### 1. 文档集合 (documents)

```python
{
    "collection_name": "documents",
    "fields": [
        {
            "name": "id",
            "type": "Int64",
            "is_primary": True,
            "auto_id": True
        },
        {
            "name": "doc_id",
            "type": "VarChar",
            "max_length": 256
        },
        {
            "name": "kb_id",
            "type": "VarChar",
            "max_length": 256
        },
        {
            "name": "file_id",
            "type": "VarChar",
            "max_length": 256
        },
        {
            "name": "content",
            "type": "VarChar",
            "max_length": 65535
        },
        {
            "name": "embedding",
            "type": "FloatVector",
            "dim": 1536  # OpenAI embedding维度
        },
        {
            "name": "metadata",
            "type": "JSON"
        },
        {
            "name": "created_at",
            "type": "Int64"
        }
    ],
    "index": {
        "field_name": "embedding",
        "index_type": "IVF_FLAT",
        "metric_type": "L2",
        "params": {
            "nlist": 1024
        }
    }
}
```

### 2. 索引策略

| 索引类型 | 适用场景 | 优点 | 缺点 |
|---------|---------|------|------|
| FLAT | 小规模数据 | 精确度高 | 查询慢 |
| IVF_FLAT | 中等规模 | 平衡性能 | 精确度略低 |
| IVF_SQ8 | 大规模数据 | 快速查询 | 精确度下降 |
| HNSW | 大规模数据 | 高精确度 | 内存占用大 |

## 数据关系图

```
users (1) ──────────── (N) knowledge_bases
                            │
                            ├─── (N) files
                            │         │
                            │         └─── (N) documents ──── Milvus
                            │
                            └─── (N) search_history

operation_logs ──── users
```

## 数据流

### 文件上传流程

```
1. 用户上传文件
   ↓
2. 创建file记录 (status=processing)
   ↓
3. 处理文件，生成chunks
   ↓
4. 创建document记录
   ↓
5. 向量化，插入Milvus
   ↓
6. 更新file记录 (status=completed)
   ↓
7. 更新knowledge_base统计信息
```

### 搜索流程

```
1. 用户输入查询
   ↓
2. 记录search_history
   ↓
3. 查询向量化
   ↓
4. Milvus向量搜索
   ↓
5. 获取document详情
   ↓
6. 返回结果
```

## 性能优化

### 1. 索引优化

```sql
-- 创建复合索引
CREATE INDEX idx_documents_kb_file ON documents(kb_id, file_id);

-- 创建部分索引
CREATE INDEX idx_active_files ON files(kb_id) WHERE deleted_at IS NULL;
```

### 2. 分区策略

```sql
-- 按知识库分区
CREATE TABLE documents_partition (
    id UUID,
    kb_id UUID,
    ...
) PARTITION BY LIST (kb_id);
```

### 3. 查询优化

```sql
-- 使用EXPLAIN分析查询
EXPLAIN ANALYZE
SELECT * FROM documents 
WHERE kb_id = 'xxx' 
ORDER BY created_at DESC 
LIMIT 10;
```

## 备份策略

### 1. PostgreSQL备份

```bash
# 全量备份
pg_dump -U user -h localhost knowledge_base > backup_full.sql

# 增量备份
pg_basebackup -U user -h localhost -D ./backup_incremental
```

### 2. Milvus备份

```python
from pymilvus import Collection

collection = Collection("documents")
collection.flush()  # 确保数据持久化
```

## 数据清理

### 1. 删除过期数据

```sql
-- 删除30天前的搜索历史
DELETE FROM search_history 
WHERE created_at < NOW() - INTERVAL '30 days';

-- 删除标记为删除的文件
DELETE FROM files 
WHERE deleted_at IS NOT NULL 
AND deleted_at < NOW() - INTERVAL '7 days';
```

### 2. 数据归档

```sql
-- 创建归档表
CREATE TABLE documents_archive AS
SELECT * FROM documents 
WHERE created_at < NOW() - INTERVAL '1 year';

-- 删除原表数据
DELETE FROM documents 
WHERE created_at < NOW() - INTERVAL '1 year';
```

## 监控指标

### 1. 数据库监控

```sql
-- 查看表大小
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- 查看索引使用情况
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_scan DESC;
```

### 2. Milvus监控

```python
from pymilvus import Collection

collection = Collection("documents")
stats = collection.num_entities
print(f"集合中的实体数: {stats}")
```

