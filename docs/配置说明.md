# 知识库管理系统 - 配置说明

## 环境变量配置

### 1. 创建 .env 文件

在项目根目录创建 `.env` 文件，参考 `.env.example`:

```bash
cp .env.example .env
```

### 2. 环境变量详解

#### FastAPI配置
```env
# 应用配置
APP_NAME=知识库管理系统
APP_VERSION=1.0.0
DEBUG=True
LOG_LEVEL=INFO

# 服务器配置
HOST=0.0.0.0
PORT=8000
WORKERS=4
```

#### 数据库配置
```env
# PostgreSQL配置
DATABASE_URL=postgresql://user:password@localhost:5432/knowledge_base
DATABASE_POOL_SIZE=20
DATABASE_MAX_OVERFLOW=10
DATABASE_POOL_RECYCLE=3600

# Milvus配置
MILVUS_HOST=localhost
MILVUS_PORT=19530
MILVUS_ALIAS=default
MILVUS_COLLECTION_NAME=documents
MILVUS_VECTOR_DIM=1536
MILVUS_INDEX_TYPE=IVF_FLAT
MILVUS_METRIC_TYPE=L2
```

#### Redis配置
```env
# Redis配置
REDIS_URL=redis://localhost:6379/0
REDIS_CACHE_TTL=3600
```

#### 文件处理配置
```env
# 文件上传配置
UPLOAD_DIR=./uploads
MAX_FILE_SIZE=104857600  # 100MB
ALLOWED_EXTENSIONS=pdf,csv,txt,jpg,png,jpeg

# 文本处理配置
CHUNK_SIZE=512
CHUNK_OVERLAP=256
MIN_CHUNK_SIZE=100
```

#### 嵌入模型配置
```env
# 嵌入模型配置
EMBEDDING_MODEL=sentence-transformers/all-MiniLM-L6-v2
EMBEDDING_DEVICE=cuda  # cuda 或 cpu
EMBEDDING_BATCH_SIZE=32

# OpenAI配置（可选）
OPENAI_API_KEY=your_api_key
OPENAI_MODEL=text-embedding-3-small
```

#### 搜索配置
```env
# 搜索配置
SEARCH_TOP_K=10
SEARCH_THRESHOLD=0.5
SEARCH_TIMEOUT=30
```

#### 日志配置
```env
# 日志配置
LOG_FILE=./logs/app.log
LOG_MAX_BYTES=10485760  # 10MB
LOG_BACKUP_COUNT=10
```

#### 认证配置
```env
# JWT配置
JWT_SECRET_KEY=your_secret_key_here
JWT_ALGORITHM=HS256
JWT_EXPIRATION_HOURS=24
```

## 配置文件

### 1. config/settings.py

```python
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    # 应用配置
    app_name: str = "知识库管理系统"
    app_version: str = "1.0.0"
    debug: bool = False
    log_level: str = "INFO"
    
    # 数据库配置
    database_url: str
    database_pool_size: int = 20
    
    # Milvus配置
    milvus_host: str = "localhost"
    milvus_port: int = 19530
    
    # 文件配置
    upload_dir: str = "./uploads"
    max_file_size: int = 104857600
    
    class Config:
        env_file = ".env"
        case_sensitive = False

settings = Settings()
```

### 2. config/logging.yaml

```yaml
version: 1
disable_existing_loggers: false

formatters:
  standard:
    format: '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
  detailed:
    format: '%(asctime)s - %(name)s - %(levelname)s - %(filename)s:%(lineno)d - %(message)s'

handlers:
  console:
    class: logging.StreamHandler
    level: DEBUG
    formatter: standard
    stream: ext://sys.stdout
  
  file:
    class: logging.handlers.RotatingFileHandler
    level: INFO
    formatter: detailed
    filename: logs/app.log
    maxBytes: 10485760  # 10MB
    backupCount: 10
  
  error_file:
    class: logging.handlers.RotatingFileHandler
    level: ERROR
    formatter: detailed
    filename: logs/error.log
    maxBytes: 10485760
    backupCount: 10

loggers:
  app:
    level: INFO
    handlers: [console, file, error_file]
    propagate: false

root:
  level: INFO
  handlers: [console, file]
```

### 3. config/milvus.yaml

```yaml
# Milvus集合配置
collection:
  name: documents
  description: 知识库文档集合
  
  # 字段定义
  fields:
    - name: id
      type: Int64
      is_primary: true
      auto_id: true
    
    - name: doc_id
      type: VarChar
      max_length: 256
    
    - name: content
      type: VarChar
      max_length: 65535
    
    - name: embedding
      type: FloatVector
      dim: 1536
    
    - name: metadata
      type: JSON
    
    - name: created_at
      type: Int64

# 索引配置
index:
  field_name: embedding
  index_type: IVF_FLAT
  metric_type: L2
  params:
    nlist: 1024

# 搜索参数
search:
  top_k: 10
  threshold: 0.5
  timeout: 30
```

## 开发环境配置

### 1. 虚拟环境设置

```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
# Windows
venv\Scripts\activate
# Linux/Mac
source venv/bin/activate
```

### 2. 安装依赖

```bash
# 安装基础依赖
pip install -r requirements.txt

# 安装开发依赖
pip install -r requirements-dev.txt
```

### 3. 初始化数据库

```bash
# 创建数据库表
python scripts/init_db.py

# 创建Milvus集合
python scripts/create_collection.py
```

## 生产环境配置

### 1. 环境变量

```env
DEBUG=False
LOG_LEVEL=WARNING
WORKERS=8
DATABASE_POOL_SIZE=50
```

### 2. Docker部署

```bash
# 构建镜像
docker build -t knowledge-base-system:latest .

# 运行容器
docker-compose up -d
```

### 3. 性能优化

- 启用Milvus索引
- 配置Redis缓存
- 使用连接池
- 启用异步处理

## 常见配置问题

### 1. Milvus连接失败

**症状**: `Failed to connect to Milvus`

**解决方案**:
- 检查Milvus服务是否运行
- 验证MILVUS_HOST和MILVUS_PORT配置
- 检查防火墙设置

### 2. 嵌入模型加载失败

**症状**: `Failed to load embedding model`

**解决方案**:
- 检查EMBEDDING_MODEL配置
- 确保有足够的磁盘空间
- 检查网络连接（首次下载模型）

### 3. 文件上传失败

**症状**: `File upload failed`

**解决方案**:
- 检查UPLOAD_DIR目录权限
- 验证MAX_FILE_SIZE配置
- 检查磁盘空间

## 配置最佳实践

1. **使用环境变量**: 不要在代码中硬编码敏感信息
2. **分环境配置**: 开发、测试、生产环境使用不同配置
3. **定期备份**: 备份重要配置文件
4. **监控日志**: 定期检查日志文件
5. **性能调优**: 根据实际使用情况调整参数

