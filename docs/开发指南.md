# 知识库管理系统 - 开发指南

## 快速开始

### 1. 环境准备

```bash
# 克隆项目
git clone <repository_url>
cd knowledge-base-system

# 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate  # Windows

# 安装依赖
pip install -r requirements-dev.txt
```

### 2. 配置环境变量

```bash
cp .env.example .env
# 编辑 .env 文件，配置本地开发环境
```

### 3. 启动依赖服务

```bash
# 使用Docker Compose启动Milvus、PostgreSQL、Redis
docker-compose up -d

# 初始化数据库
python scripts/init_db.py
python scripts/create_collection.py
```

### 4. 启动应用

```bash
# 开发模式（自动重载）
uvicorn app.main:app --reload

# 应用将在 http://localhost:8000 运行
# API文档: http://localhost:8000/docs
```

## 项目结构导航

### 添加新的API端点

1. **创建路由文件** (app/api/v1/new_feature.py):
```python
from fastapi import APIRouter, Depends
from app.services import NewFeatureService

router = APIRouter(prefix="/new-feature", tags=["new-feature"])

@router.get("/")
async def get_items(service: NewFeatureService = Depends()):
    return await service.get_items()
```

2. **注册路由** (app/main.py):
```python
from app.api.v1 import new_feature

app.include_router(new_feature.router, prefix="/api/v1")
```

3. **创建服务** (app/services/new_feature_service.py):
```python
class NewFeatureService:
    async def get_items(self):
        # 业务逻辑
        pass
```

### 添加新的文件处理器

1. **继承基类** (app/core/file_processor/new_processor.py):
```python
from app.core.file_processor.base import FileProcessor

class NewFileProcessor(FileProcessor):
    def __init__(self):
        self.supported_extensions = ['.new']
    
    def process(self, file_path: str) -> str:
        # 实现文件处理逻辑
        with open(file_path, 'r') as f:
            content = f.read()
        return content
```

2. **注册处理器** (app/core/file_processor/__init__.py):
```python
from .new_processor import NewFileProcessor

PROCESSORS = {
    '.new': NewFileProcessor(),
}
```

### 添加新的嵌入模型

1. **在embeddings.py中添加**:
```python
class EmbeddingManager:
    def __init__(self, model_name: str):
        if model_name == "new-model":
            self.model = load_new_model()
        else:
            self.model = load_default_model()
    
    def embed(self, texts: List[str]) -> np.ndarray:
        return self.model.encode(texts)
```

## 编码规范

### 1. 代码风格

- 使用 **Black** 格式化代码
- 使用 **isort** 组织导入
- 使用 **pylint** 检查代码质量

```bash
# 格式化代码
black app/

# 组织导入
isort app/

# 检查代码质量
pylint app/
```

### 2. 类型提示

所有函数都应该有类型提示:

```python
from typing import List, Optional
from app.models.schemas import Document

def search_documents(
    query: str,
    top_k: int = 10,
    threshold: Optional[float] = None
) -> List[Document]:
    """搜索文档"""
    pass
```

### 3. 文档字符串

使用Google风格的文档字符串:

```python
def process_file(file_path: str, chunk_size: int = 512) -> str:
    """处理文件并返回文本内容。
    
    Args:
        file_path: 文件路径
        chunk_size: 分块大小，默认512
    
    Returns:
        处理后的文本内容
    
    Raises:
        FileNotFoundError: 文件不存在
        ValueError: 不支持的文件格式
    """
    pass
```

### 4. 异常处理

使用自定义异常:

```python
from app.utils.exceptions import FileProcessingError

try:
    content = process_file(file_path)
except FileNotFoundError:
    raise FileProcessingError(f"文件不存在: {file_path}")
```

## 测试

### 1. 单元测试

```bash
# 运行所有单元测试
pytest tests/unit/

# 运行特定测试
pytest tests/unit/test_file_processor.py

# 显示覆盖率
pytest --cov=app tests/unit/
```

### 2. 集成测试

```bash
# 运行集成测试
pytest tests/integration/

# 运行特定集成测试
pytest tests/integration/test_file_upload.py
```

### 3. 编写测试

```python
import pytest
from app.core.file_processor import PDFProcessor

@pytest.fixture
def pdf_processor():
    return PDFProcessor()

def test_pdf_processing(pdf_processor, tmp_path):
    """测试PDF处理"""
    # 创建测试文件
    test_file = tmp_path / "test.pdf"
    
    # 执行处理
    result = pdf_processor.process(str(test_file))
    
    # 断言
    assert isinstance(result, str)
    assert len(result) > 0
```

## 调试

### 1. 启用调试模式

```bash
# 设置DEBUG环境变量
export DEBUG=True
uvicorn app.main:app --reload
```

### 2. 使用日志

```python
import logging

logger = logging.getLogger(__name__)

logger.debug("调试信息")
logger.info("信息")
logger.warning("警告")
logger.error("错误")
```

### 3. 使用IDE调试器

在VSCode中配置launch.json:

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "FastAPI",
            "type": "python",
            "request": "launch",
            "module": "uvicorn",
            "args": ["app.main:app", "--reload"],
            "jinja": true
        }
    ]
}
```

## 性能优化

### 1. 数据库查询优化

- 使用索引
- 避免N+1查询
- 使用连接池

### 2. 向量搜索优化

- 使用Milvus索引
- 调整搜索参数
- 批量操作

### 3. 缓存策略

```python
from functools import lru_cache

@lru_cache(maxsize=128)
def get_embedding_model(model_name: str):
    return load_model(model_name)
```

## 常见问题

### 1. 导入错误

**问题**: `ModuleNotFoundError: No module named 'app'`

**解决方案**:
- 确保在项目根目录运行
- 检查PYTHONPATH设置
- 确保虚拟环境已激活

### 2. 数据库连接错误

**问题**: `psycopg2.OperationalError: could not connect to server`

**解决方案**:
- 检查PostgreSQL是否运行
- 验证DATABASE_URL配置
- 检查数据库凭证

### 3. Milvus连接错误

**问题**: `pymilvus.exceptions.MilvusException: Fail to connect`

**解决方案**:
- 检查Milvus服务状态
- 验证MILVUS_HOST和MILVUS_PORT
- 检查网络连接

## 提交代码

### 1. 代码审查清单

- [ ] 代码通过所有测试
- [ ] 代码风格符合规范
- [ ] 添加了必要的文档
- [ ] 没有硬编码的敏感信息
- [ ] 性能满足要求

### 2. 提交信息格式

```
feat: 添加新功能
fix: 修复bug
docs: 更新文档
test: 添加测试
refactor: 代码重构
```

## 资源链接

- [FastAPI文档](https://fastapi.tiangolo.com/)
- [Milvus文档](https://milvus.io/docs)
- [SQLAlchemy文档](https://docs.sqlalchemy.org/)
- [Pydantic文档](https://docs.pydantic.dev/)
- [pytest文档](https://docs.pytest.org/)

