# 知识库管理系统 - 部署指南

## 本地开发部署

### 1. 前置条件

- Python 3.9+
- Docker & Docker Compose
- Git

### 2. 快速启动

```bash
# 克隆项目
git clone <repository_url>
cd knowledge-base-system

# 启动依赖服务
docker-compose up -d

# 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate  # Windows

# 安装依赖
pip install -r requirements.txt

# 初始化数据库
python scripts/init_db.py
python scripts/create_collection.py

# 启动应用
uvicorn app.main:app --reload
```

### 3. 验证部署

```bash
# 检查API文档
curl http://localhost:8000/docs

# 检查健康状态
curl http://localhost:8000/api/v1/health
```

## Docker部署

### 1. 构建镜像

```bash
# 构建镜像
docker build -t knowledge-base-system:latest .

# 查看镜像
docker images | grep knowledge-base-system
```

### 2. 运行容器

```bash
# 使用Docker Compose
docker-compose up -d

# 查看日志
docker-compose logs -f app

# 停止服务
docker-compose down
```

### 3. Docker Compose配置

```yaml
version: '3.8'

services:
  # FastAPI应用
  app:
    build: .
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://user:password@postgres:5432/knowledge_base
      - MILVUS_HOST=milvus
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - postgres
      - milvus
      - redis
    volumes:
      - ./uploads:/app/uploads
      - ./logs:/app/logs
    networks:
      - knowledge-base-network

  # PostgreSQL数据库
  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=knowledge_base
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - knowledge-base-network

  # Milvus向量数据库
  milvus:
    image: milvusdb/milvus:latest
    environment:
      - COMMON_STORAGETYPE=local
    ports:
      - "19530:19530"
      - "9091:9091"
    volumes:
      - milvus_data:/var/lib/milvus
    networks:
      - knowledge-base-network

  # Redis缓存
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - knowledge-base-network

volumes:
  postgres_data:
  milvus_data:
  redis_data:

networks:
  knowledge-base-network:
    driver: bridge
```

## Kubernetes部署

### 1. 创建命名空间

```bash
kubectl create namespace knowledge-base
```

### 2. 部署应用

```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: knowledge-base-app
  namespace: knowledge-base
spec:
  replicas: 3
  selector:
    matchLabels:
      app: knowledge-base-app
  template:
    metadata:
      labels:
        app: knowledge-base-app
    spec:
      containers:
      - name: app
        image: knowledge-base-system:latest
        ports:
        - containerPort: 8000
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: url
        - name: MILVUS_HOST
          value: milvus-service
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
```

### 3. 创建服务

```yaml
# service.yaml
apiVersion: v1
kind: Service
metadata:
  name: knowledge-base-service
  namespace: knowledge-base
spec:
  type: LoadBalancer
  ports:
  - port: 80
    targetPort: 8000
  selector:
    app: knowledge-base-app
```

### 4. 部署

```bash
kubectl apply -f deployment.yaml
kubectl apply -f service.yaml

# 查看部署状态
kubectl get pods -n knowledge-base
kubectl get svc -n knowledge-base
```

## 云平台部署

### AWS部署

```bash
# 使用AWS ECR
aws ecr create-repository --repository-name knowledge-base-system

# 推送镜像
docker tag knowledge-base-system:latest <aws_account_id>.dkr.ecr.<region>.amazonaws.com/knowledge-base-system:latest
docker push <aws_account_id>.dkr.ecr.<region>.amazonaws.com/knowledge-base-system:latest

# 使用ECS部署
aws ecs create-service --cluster knowledge-base --service-name app --task-definition knowledge-base-task
```

### 阿里云部署

```bash
# 登录阿里云镜像仓库
docker login -u <username> registry.cn-hangzhou.aliyuncs.com

# 推送镜像
docker tag knowledge-base-system:latest registry.cn-hangzhou.aliyuncs.com/namespace/knowledge-base-system:latest
docker push registry.cn-hangzhou.aliyuncs.com/namespace/knowledge-base-system:latest

# 使用ACK部署
kubectl apply -f deployment.yaml
```

## 生产环境配置

### 1. 环境变量

```env
# 应用配置
DEBUG=False
LOG_LEVEL=WARNING
WORKERS=8

# 数据库配置
DATABASE_URL=postgresql://user:password@db.example.com:5432/knowledge_base
DATABASE_POOL_SIZE=50
DATABASE_MAX_OVERFLOW=20

# Milvus配置
MILVUS_HOST=milvus.example.com
MILVUS_PORT=19530

# Redis配置
REDIS_URL=redis://redis.example.com:6379/0

# 文件配置
UPLOAD_DIR=/data/uploads
MAX_FILE_SIZE=104857600

# 安全配置
JWT_SECRET_KEY=<strong_secret_key>
ALLOWED_HOSTS=api.example.com
```

### 2. 性能优化

```yaml
# Milvus性能优化
milvus:
  cache:
    cache_size: 4GB
  index:
    index_type: IVF_FLAT
    nlist: 1024
  search:
    top_k: 10
    timeout: 30

# PostgreSQL性能优化
postgres:
  max_connections: 200
  shared_buffers: 256MB
  effective_cache_size: 1GB
  work_mem: 16MB
```

### 3. 监控和告警

```bash
# 使用Prometheus监控
docker run -d \
  -p 9090:9090 \
  -v /path/to/prometheus.yml:/etc/prometheus/prometheus.yml \
  prom/prometheus

# 使用Grafana可视化
docker run -d \
  -p 3000:3000 \
  grafana/grafana
```

## 备份和恢复

### 1. 数据库备份

```bash
# PostgreSQL备份
pg_dump -U user -h localhost knowledge_base > backup.sql

# 恢复
psql -U user -h localhost knowledge_base < backup.sql
```

### 2. Milvus备份

```bash
# 使用Milvus备份工具
python -m pymilvus backup --host localhost --port 19530 --backup_dir ./backup
```

### 3. 自动备份脚本

```bash
#!/bin/bash
# backup.sh

BACKUP_DIR="/backups"
DATE=$(date +%Y%m%d_%H%M%S)

# PostgreSQL备份
pg_dump -U user -h localhost knowledge_base > $BACKUP_DIR/postgres_$DATE.sql

# Milvus备份
python -m pymilvus backup --host localhost --port 19530 --backup_dir $BACKUP_DIR/milvus_$DATE

# 上传到云存储
aws s3 cp $BACKUP_DIR s3://backup-bucket/ --recursive
```

## 故障排查

### 1. 应用无法启动

```bash
# 查看日志
docker-compose logs app

# 检查依赖服务
docker-compose ps

# 重启服务
docker-compose restart
```

### 2. 数据库连接失败

```bash
# 检查PostgreSQL
docker-compose exec postgres psql -U user -d knowledge_base -c "SELECT 1"

# 检查Milvus
docker-compose exec milvus python -c "from pymilvus import connections; connections.connect()"
```

### 3. 性能问题

```bash
# 检查资源使用
docker stats

# 查看慢查询
docker-compose exec postgres psql -U user -d knowledge_base -c "SELECT * FROM pg_stat_statements"
```

## 升级指南

### 1. 备份数据

```bash
# 备份所有数据
./backup.sh
```

### 2. 更新代码

```bash
git pull origin main
```

### 3. 更新依赖

```bash
pip install -r requirements.txt --upgrade
```

### 4. 数据库迁移

```bash
python scripts/migrate.py
```

### 5. 重启应用

```bash
docker-compose restart app
```

### 6. 验证升级

```bash
curl http://localhost:8000/api/v1/health
```

## 安全建议

1. **使用HTTPS**: 配置SSL证书
2. **认证授权**: 实现JWT认证
3. **速率限制**: 防止API滥用
4. **输入验证**: 验证所有用户输入
5. **日志审计**: 记录所有操作
6. **定期更新**: 及时更新依赖包
7. **备份策略**: 定期备份重要数据
8. **访问控制**: 限制数据库访问

