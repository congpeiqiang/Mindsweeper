# ğŸ’» Mindsweeper ä»£ç ä½¿ç”¨ç¤ºä¾‹

## ğŸ“š ç›®å½•

1. [æ•°æ®åº“æ“ä½œ](#æ•°æ®åº“æ“ä½œ)
2. [APIè¯·æ±‚/å“åº”](#apiè¯·æ±‚å“åº”)
3. [é…ç½®ä½¿ç”¨](#é…ç½®ä½¿ç”¨)
4. [å®Œæ•´ç¤ºä¾‹](#å®Œæ•´ç¤ºä¾‹)

---

## æ•°æ®åº“æ“ä½œ

### å¯¼å…¥æ•°æ®åº“æ¨¡å‹

```python
from app.schema import (
    User,
    KnowledgeBase,
    File,
    Document,
    SearchHistory,
    OperationLog,
)
from sqlalchemy.orm import Session
```

### åˆ›å»ºç”¨æˆ·

```python
def create_user(db: Session, username: str, email: str, password_hash: str):
    """åˆ›å»ºç”¨æˆ·"""
    user = User(
        username=username,
        email=email,
        password_hash=password_hash,
        full_name="John Doe",
        is_active=True
    )
    db.add(user)
    db.commit()
    db.refresh(user)
    return user

# ä½¿ç”¨
user = create_user(db, "john_doe", "john@example.com", "hashed_password")
print(f"åˆ›å»ºç”¨æˆ·: {user.username}")
```

### åˆ›å»ºçŸ¥è¯†åº“

```python
def create_knowledge_base(db: Session, user_id: int, name: str, description: str):
    """åˆ›å»ºçŸ¥è¯†åº“"""
    kb = KnowledgeBase(
        user_id=user_id,
        name=name,
        description=description,
        embedding_model="sentence-transformers/all-MiniLM-L6-v2",
        status="active"
    )
    db.add(kb)
    db.commit()
    db.refresh(kb)
    return kb

# ä½¿ç”¨
kb = create_knowledge_base(db, user.id, "æŠ€æœ¯æ–‡æ¡£åº“", "å­˜å‚¨æŠ€æœ¯ç›¸å…³æ–‡æ¡£")
print(f"åˆ›å»ºçŸ¥è¯†åº“: {kb.name}")
```

### ä¸Šä¼ æ–‡ä»¶

```python
def upload_file(db: Session, kb_id: UUID, filename: str, file_size: int, file_path: str):
    """ä¸Šä¼ æ–‡ä»¶"""
    file = File(
        kb_id=kb_id,
        filename=filename,
        file_type=filename.split('.')[-1],
        file_size=file_size,
        file_path=file_path,
        status="processing"
    )
    db.add(file)
    db.commit()
    db.refresh(file)
    return file

# ä½¿ç”¨
file = upload_file(db, kb.id, "document.pdf", 1024000, "/uploads/document.pdf")
print(f"ä¸Šä¼ æ–‡ä»¶: {file.filename}")
```

### åˆ›å»ºæ–‡æ¡£

```python
def create_document(db: Session, file_id: UUID, kb_id: UUID, content: str, chunk_index: int):
    """åˆ›å»ºæ–‡æ¡£"""
    doc = Document(
        file_id=file_id,
        kb_id=kb_id,
        content=content,
        chunk_index=chunk_index,
        metadata={"source": "pdf", "page": 1}
    )
    db.add(doc)
    db.commit()
    db.refresh(doc)
    return doc

# ä½¿ç”¨
doc = create_document(db, file.id, kb.id, "è¿™æ˜¯æ–‡æ¡£å†…å®¹...", 1)
print(f"åˆ›å»ºæ–‡æ¡£: {doc.id}")
```

### æŸ¥è¯¢æ•°æ®

```python
# æŸ¥è¯¢ç”¨æˆ·
user = db.query(User).filter(User.username == "john_doe").first()

# æŸ¥è¯¢çŸ¥è¯†åº“
kbs = db.query(KnowledgeBase).filter(KnowledgeBase.user_id == user.id).all()

# æŸ¥è¯¢æ–‡ä»¶
files = db.query(File).filter(File.kb_id == kb.id).all()

# æŸ¥è¯¢æ–‡æ¡£
docs = db.query(Document).filter(Document.file_id == file.id).all()
```

### æ›´æ–°æ•°æ®

```python
# æ›´æ–°æ–‡ä»¶çŠ¶æ€
file.status = "completed"
file.chunks_count = 50
db.commit()

# æ›´æ–°çŸ¥è¯†åº“ç»Ÿè®¡
kb.files_count += 1
kb.documents_count += 50
kb.total_size += file.file_size
db.commit()
```

### åˆ é™¤æ•°æ®

```python
# è½¯åˆ é™¤ï¼ˆæ¨èï¼‰
from datetime import datetime
file.deleted_at = datetime.utcnow()
db.commit()

# ç¡¬åˆ é™¤
db.delete(file)
db.commit()
```

---

## APIè¯·æ±‚/å“åº”

### å¯¼å…¥æ¨¡å‹

```python
from app.models import (
    UserCreate,
    UserResponse,
    KnowledgeBaseCreate,
    KnowledgeBaseResponse,
    SearchRequest,
    SearchResponse,
    FileResponse,
    DocumentResponse,
)
```

### ç”¨æˆ·ç›¸å…³

```python
# åˆ›å»ºç”¨æˆ·è¯·æ±‚
user_create = UserCreate(
    username="john_doe",
    email="john@example.com",
    password="password123",
    full_name="John Doe"
)

# ç”¨æˆ·å“åº”
user_response = UserResponse(
    id=1,
    username="john_doe",
    email="john@example.com",
    full_name="John Doe",
    is_active=True,
    created_at=datetime.utcnow(),
    updated_at=datetime.utcnow()
)

# è½¬æ¢ä¸ºJSON
user_json = user_response.model_dump_json()
```

### çŸ¥è¯†åº“ç›¸å…³

```python
# åˆ›å»ºçŸ¥è¯†åº“è¯·æ±‚
kb_create = KnowledgeBaseCreate(
    name="æŠ€æœ¯æ–‡æ¡£åº“",
    description="å­˜å‚¨æŠ€æœ¯ç›¸å…³æ–‡æ¡£",
    embedding_model="sentence-transformers/all-MiniLM-L6-v2"
)

# çŸ¥è¯†åº“å“åº”
kb_response = KnowledgeBaseResponse(
    id=UUID("550e8400-e29b-41d4-a716-446655440000"),
    name="æŠ€æœ¯æ–‡æ¡£åº“",
    description="å­˜å‚¨æŠ€æœ¯ç›¸å…³æ–‡æ¡£",
    embedding_model="sentence-transformers/all-MiniLM-L6-v2",
    status="active",
    files_count=10,
    documents_count=500,
    total_size=10485760,
    created_at=datetime.utcnow(),
    updated_at=datetime.utcnow()
)
```

### æœç´¢ç›¸å…³

```python
# æœç´¢è¯·æ±‚
search_req = SearchRequest(
    query="Pythonæ•™ç¨‹",
    knowledge_base_id=UUID("550e8400-e29b-41d4-a716-446655440000"),
    top_k=10,
    threshold=0.5
)

# æ··åˆæœç´¢è¯·æ±‚
hybrid_search = HybridSearchRequest(
    query="Pythonæ•™ç¨‹",
    knowledge_base_id=UUID("550e8400-e29b-41d4-a716-446655440000"),
    top_k=10,
    vector_weight=0.7,
    keyword_weight=0.3
)

# æœç´¢å“åº”
search_response = SearchResponse(
    query="Pythonæ•™ç¨‹",
    results=[
        SearchResult(
            doc_id=UUID("550e8400-e29b-41d4-a716-446655440001"),
            file_id=UUID("550e8400-e29b-41d4-a716-446655440002"),
            filename="python_tutorial.pdf",
            content="Pythonæ˜¯ä¸€ç§ç¼–ç¨‹è¯­è¨€...",
            score=0.95,
            chunk_index=1
        )
    ],
    total=1,
    execution_time=100.5
)
```

---

## é…ç½®ä½¿ç”¨

### å¯¼å…¥é…ç½®

```python
from app.config.settings import settings

# è·å–é…ç½®å€¼
print(f"åº”ç”¨åç§°: {settings.APP_NAME}")
print(f"æ•°æ®åº“URL: {settings.DATABASE_URL}")
print(f"Milvusä¸»æœº: {settings.MILVUS_HOST}")
```

### åˆ›å»ºæ•°æ®åº“è¿æ¥

```python
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

# åˆ›å»ºå¼•æ“
engine = create_engine(
    settings.DATABASE_URL,
    echo=settings.DATABASE_ECHO,
    pool_size=settings.DATABASE_POOL_SIZE,
    max_overflow=settings.DATABASE_MAX_OVERFLOW,
)

# åˆ›å»ºä¼šè¯å·¥å‚
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

# è·å–ä¼šè¯
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

### åˆ›å»ºRedisè¿æ¥

```python
import redis

# åˆ›å»ºRedisè¿æ¥
redis_client = redis.from_url(settings.REDIS_URL)

# ä½¿ç”¨ç¼“å­˜
def get_cached_data(key):
    data = redis_client.get(key)
    return data

def set_cached_data(key, value, ttl=None):
    ttl = ttl or settings.REDIS_CACHE_TTL
    redis_client.setex(key, ttl, value)
```

---

## å®Œæ•´ç¤ºä¾‹

### FastAPIè·¯ç”±ç¤ºä¾‹

```python
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from app.models import KnowledgeBaseCreate, KnowledgeBaseResponse
from app.schema import KnowledgeBase
from app.config.settings import settings

router = APIRouter(prefix="/api/v1/knowledge-bases", tags=["knowledge-bases"])


@router.post("/", response_model=KnowledgeBaseResponse)
def create_knowledge_base(
        kb_create: KnowledgeBaseCreate,
        db: Session = Depends(get_db),
        current_user=Depends(get_current_user)
):
    """åˆ›å»ºçŸ¥è¯†åº“"""
    kb = KnowledgeBase(
        user_id=current_user.id,
        name=kb_create.name,
        description=kb_create.description,
        embedding_model=kb_create.embedding_model,
        status="active"
    )
    db.add(kb)
    db.commit()
    db.refresh(kb)
    return kb


@router.get("/{kb_id}", response_model=KnowledgeBaseResponse)
def get_knowledge_base(
        kb_id: UUID,
        db: Session = Depends(get_db),
        current_user=Depends(get_current_user)
):
    """è·å–çŸ¥è¯†åº“è¯¦æƒ…"""
    kb = db.query(KnowledgeBase).filter(
        KnowledgeBase.id == kb_id,
        KnowledgeBase.user_id == current_user.id
    ).first()

    if not kb:
        raise HTTPException(status_code=404, detail="çŸ¥è¯†åº“ä¸å­˜åœ¨")

    return kb
```

### æœåŠ¡å±‚ç¤ºä¾‹

```python
from app.schema import File, Document
from app.models import FileStatus

class FileService:
    def __init__(self, db: Session):
        self.db = db
    
    def create_file(self, kb_id: UUID, filename: str, file_size: int, file_path: str):
        """åˆ›å»ºæ–‡ä»¶"""
        file = File(
            kb_id=kb_id,
            filename=filename,
            file_type=filename.split('.')[-1],
            file_size=file_size,
            file_path=file_path,
            status=FileStatus.PROCESSING
        )
        self.db.add(file)
        self.db.commit()
        self.db.refresh(file)
        return file
    
    def update_file_status(self, file_id: UUID, status: FileStatus):
        """æ›´æ–°æ–‡ä»¶çŠ¶æ€"""
        file = self.db.query(File).filter(File.id == file_id).first()
        if file:
            file.status = status
            self.db.commit()
            self.db.refresh(file)
        return file
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. ä½¿ç”¨ä¾èµ–æ³¨å…¥
```python
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

@app.get("/")
def read_root(db: Session = Depends(get_db)):
    pass
```

### 2. ä½¿ç”¨äº‹åŠ¡
```python
try:
    db.add(obj)
    db.commit()
except Exception as e:
    db.rollback()
    raise
```

### 3. ä½¿ç”¨åˆ†é¡µ
```python
def get_paginated_items(db: Session, skip: int = 0, limit: int = 10):
    return db.query(Item).offset(skip).limit(limit).all()
```

### 4. ä½¿ç”¨ç¼“å­˜
```python
cache_key = f"kb:{kb_id}"
cached = redis_client.get(cache_key)
if cached:
    return json.loads(cached)
```

---

**é¡¹ç›®åç§°**: Mindsweeper  
**ç‰ˆæœ¬**: 1.0.0  
**æœ€åæ›´æ–°**: 2024å¹´1æœˆ

